<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <!-- CHARTJS SCRIPT-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
    
    
    
    <style>
      /* KEYFRAMES */
      
      /* SPIN KEYFRAME */
      @-webkit-keyframes spin {
        0% { -webkit-transform: rotate(0deg); }
        100% { -webkit-transform: rotate(360deg); }
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* FADE IN FADE OUT*/ 
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      
      /* FOR TABLES IN GENERAL */
      table {
          font-family: arial, sans-serif;
          border-collapse: collapse;
          width: 100%;
          text-align: center;
          margin-bottom: 25px;
      }
      
      th {
        background-color: #D3D3D3;
        font-size: 18px;
        padding: 8px;
        border-right: 1px solid gray;
      }
      
      td {
        background-color: #FAFAFA;
        font-size: 16px;
        padding: 10px;
        height: 45px;
        border-bottom: 0.5px solid gray;
      }
      
      th:last-child {
        border-right: none;
      }
      
      tr:last-child td {
        border-bottom: none;
      }
      
      /* CURVED EDGES FOR TABLES */
      /* bottom (td) */
      tr:last-child td:first-child {
        border-radius: 0 0 0 15px;
      }
      
      tr:last-child td:last-child {
        border-radius: 0 0 15px 0;
      }
      /*top (th)*/
      tr:first-child th:first-child { 
        border-radius: 15px 0 0 0; 
      } 
      
      tr:first-child th:last-child { 
        border-radius: 0 15px 0 0; 
      }
      
      /* FOR DATES AND SUBMIT BUTTON*/
      .date {
        font-size: 14px;
        font-weight: bold;
      }
      
      input[type="date"] {
        border-radius:8px;
      }
      
      .submit {
        padding: 2.5px;
        border-radius: 4px;
        background-color: #gray;
        border: 1px solid gray;
        cursor: pointer;
      }
      
      /* YEAR */
      .year {
        width: 50px;
      }
      
      /* QUARTER */
      .quarter {
        border-radius: 5px;
      }
      
      /* LOGIN CHART */
      #loginTableWrapper {
        position:relative;
      }
      
      /* curve second to last column because of hidden column in loginChart*/
      #loginChart tr:last-child td:nth-last-child(2) {
        border-radius: 0 0 15px 0;
      }
      
      #loginChart tr td.blueU {
        color: blue;
        text-decoration: underline;
      }
      
      #loginChart .blueU:hover {
        cursor: pointer;
        background: #999;
        color: #fff;
      }
      
      #loginChartCompanyNamesSpan {
        font-weight: bold;
      }
      
      #loginChartCompanyNames {
        display: none;
        opacity: 0;
        animation: fadeIn 2.5s ease forwards;
      }
      
      #loader {
        position: absolute;
        left: 50%;
        top: 400px;
        z-index: 1;
        width: 150px;
        height: 150px;
        margin: -75px 0 0 -75px;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 25px;
        height: 25px;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
      }
    
      /* USER ROLE TABLE*/
      #userRoleTableWrapper {
        position: relative;
      }
      
      #userRoleTable tr {
        border-bottom: 0.5px solid gray;
      }
      
      #userRoleTable tr:last-child {
        border-bottom: none;
      }
      
      #loader2 {
        position: absolute;
        left: 50%;
        top: 70%;
        z-index: 1;
        width: 150px;
        height: 150px;
        margin: -75px 0 0 -75px;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 25px;
        height: 25px;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
      }
      
      /* USER ROLE GRAPH */
      #userRoleGraphWrapper {
        position: relative;
      }
      
      #userRoleGraph td {
        width: calc(100%/2);
      }
      
      #userRoleGraph caption {
        font-weight: bold;
        font-size: 24px;
      }
      /* curve the tds because the table has no th*/
      #userRoleGraph tr:first-child td:first-child {
        border-radius: 15px 0 0 0;
      }
      
      #userRoleGraph tr:first-child td:last-child {
        border-radius: 0 15px 0 0;
      }
      
      #userRoleGraphLabel {
        display: inline-block;
        font-weight: bold;
      }
      
      #loader3 {
        position: absolute;
        left: 55%;
        top: 50%;
        z-index: 1;
        width: 150px;
        height: 150px;
        margin: -75px 0 0 -75px;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 25px;
        height: 25px;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
      }
      
      /* USER ROLE COMPANIES UNIQUE TABLE */
      #userRoleCompaniesUniqueTable {
        display:none;
        opacity: 0;
        animation: fadeIn 2.5s ease forwards;
      }
      
      #userRoleCompaniesUniqueTable th:nth-child(2n+1) {
        border-right: none;
      }
      
      #userRoleCompaniesUniqueTable tr td:nth-child(2n) {
        border-right: 0.5px gray solid;
      }
      
      #userRoleCompaniesUniqueTable tr td {
        height: 0px;
        padding: 8px;
      }
      
      #userRoleCompaniesUniqueTable tr th:last-child, #userRoleCompaniesUniqueTable tr td:last-child {
        border-right: none;
      }
      
      /* USER ROLE COMPANIES TOTAL TABLE*/
      #userRoleCompaniesTotalTable {
        display: none;
        opacity: 0;
        animation: fadeIn 2.5s ease forwards;
      }
      
      #userRoleCompaniesTotalTable tr td {
        border-right: 0.5px gray solid;
      }
      
      #userRoleCompaniesTotalTable tr td:nth-child(3n) {
        border-right: 2.2px black solid;
      }
      
      #userRoleCompaniesTotalTable tr th:nth-child(3n) {
        border-right: 2.2px black solid;
      }
      
      #userRoleCompaniesTotalTable tr td:last-child {
        border-right: none;
      }
      
      #userRoleCompaniesTotalTable tr th:last-child {
        border-right: none;
      }
      
      #loader4 {
        display: none;
        position: absolute;
        left: 55%;
        /*top: 25%;*/
        z-index: 1;
        width: 150px;
        height: 150px;
        margin: -75px 0 0 -75px;
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        width: 25px;
        height: 25px;
        -webkit-animation: spin 2s linear infinite;
        animation: spin 2s linear infinite;
      }
      
      #userRoleGraphCompanyNames {
        font-weight: bold; 
      }
      
      /* ONCLICK TABLES*/ 
      #loginChartCompanyNames tr th, #userRoleCompaniesUniqueTable tr th, #userRoleCompaniesTotalTable tr th {
        background-color: #a6a6a6;
      }
      
    </style>
    

  </head>
  <body class="mixpanel-platform-body">
    
    <!-- LOGIN CHART TABLE-->
    <div id="loginTableWrapper">
      <!-- above login chart table-->
      <label class=date>From:&nbsp;</label>
      <input type="date" name=from value="2018-06-01" id="from">&nbsp;
  
      <label class=date>To:&nbsp;</label>
      <input type="date" name=to value="2018-06-30" id="to">&nbsp;
      
      <input type="submit" value="Submit" id="submit" class="submit">
      
      <hr>
      
      <span id="error"></span>
      <br>
      
      <!-- login chart table-->
      <table id="loginChart">
        <tr>
          <th>CustomerType</th>
          <th>Customer Classification</th>
          <th>Number Of Customers</th>
          <th>Number Of Customers With A Login</th>
          <th>PortalViewer Customers With a Login</th>
          <th>% of Customers Who Logged In</th>
        </tr>
        <tr>
          <td>Non-Advisory</td>
          <td>Retail Auction Only</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <!-- fake column-->
          <td hidden>0</td>
        </tr>
        <tr>
          <td>Non-Advisory</td>
          <td>Retail Direct Sourcing Only</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <!-- fake column-->
          <td hidden>1</td>
        </tr>
        <tr>
          <td>Non-Advisory</td>
          <td>Retail Auction & Direct Sourcing</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <!-- fake column-->
          <td hidden>2</td>
        </tr>
        <tr>
          <td>Non-Advisory</td>
          <td>Wholesale</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <!-- fake column-->
          <td hidden>3</td>
        </tr>
        <tr>
          <td>Advisory</td>
          <td>Retail Auction Only</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <!-- fake column-->
          <td hidden>4</td>
        </tr>
        <tr>
          <td>Advisory</td>
          <td>Retail Direct Sourcing Only</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <!-- fake column-->
          <td hidden>5</td>
        </tr>
        <tr>
          <td>Advisory</td>
          <td>Retail Auction & Direct Sourcing</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <!-- fake column-->
          <td hidden>6</td>
        </tr>
        <tr>
          <td></td>
          <td>Retail Auction Totals</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <!-- fake column-->
          <td hidden>7</td>
        </tr>
      </table>
      
      <span id="loginChartCompanyNamesSpan"></span>
      
      <!-- Show Company Names Table -->
      <table id="loginChartCompanyNames">
        <tr>
          <th>Company Name</th>
        </tr>
      </table>
      <!-- loader --> 
      <div id="loader"></div>
    </div>
    <!-- USER ROLE TABLE -->
    <div id="userRoleTableWrapper">
      <!-- above user role table -->
      <label class=date>From:&nbsp;</label>
      <input type="date" value="2018-06-01" id="fromLogins">&nbsp;
      <label class=date>To:&nbsp;</label>
      <input type="date" value="2018-06-30" id="toLogins">&nbsp;
      
      <!-- quarter input-->
      <select id="userRoleTableQuarter" class="quarter">
        <option value=0>Quarter 1</option>
        <option value=1 selected>Quarter 2</option>
        <option value=2>Quarter 3</option>
        <option value=3>Quarter 4</option>
      </select>
      
      <label class="date">Year:</label>
      <input type="number" id="userRoleTableYear" class="year">
      
      <input type="submit" value="Submit" id="userRoleTableSubmit" class="submit">
      
      <hr>
      
      <!-- user role table-->
      <table id="userRoleTable">
        <tr>
          <th></th>
          <th>EnerNOC User</th>
          <th>Supplier</th>
          <th>Partner</th>
          <th>Customer</th>
        </tr>
        <tr>
          <td>Unique User Logins</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td>Total Logins</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        <tr>
          <td>Logins Per User</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
        
      </table>
      <!-- loader2 -->
      <div id="loader2"></div>
    </div>
    <!-- USER ROLE GRAPH-->
    <div id="userRoleGraphWrapper">
      <!-- above user role graph-->
      <label class="date">Login:</label>
      <select id="userRoleGraphSelect">
        <option value="unique">Unique</option>
        <option value="total">Total</option>
      </select>
      
      <label class="date">Year:</label>
      <input type="number" id="userRoleGraphYear" class="year">
      
      <input type="submit" value="Submit" id="userRoleGraphSubmit" class="submit">
      
      <input type="number" id="userRoleMaxQ1" hidden>
      <input type="number" id="userRoleMaxQ2" hidden>
      <input type="number" id="userRoleMaxQ3" hidden>
      <input type="number" id="userRoleMaxQ4" hidden>
      
      <hr>
      
      <!-- user role graph-->
      <table id="userRoleGraph">
        <caption></caption>
        <tr>
          <td><canvas></canvas></td>
          <td><canvas></canvas></td>
        </tr>
        <tr>
          <td><canvas></canvas></td>
          <td><canvas></canvas></td>
        </tr>
      </table>
      <!-- loader 3-->
      <div id="loader3"></div>
      
      <!-- USER ROLE GRAPH COMPANY NAMES -->
      <div>
        <!-- label -->
        <span id="userRoleGraphCompanyNames"></span>
        <!-- loader 4-->
        <div id="loader4"></div>
        <!-- UNIQUE TABLE-->
        <table id="userRoleCompaniesUniqueTable">
          <tr>
            <th>Company Name</th>
            <th>UserID</th>
          </tr>
        </table>
        <!-- TOTAL TABLE -->
        <table id="userRoleCompaniesTotalTable">
          <tr>
            <th>Company Name</th>
            <th>UserID</th>
            <th>Logins</th>
          </tr>
        </table>
      </div>
    </div>
    
    <script>
        // LOGIN CHART TABLE
        var runPeopleQuery = function() {
          MP.api.jql(function main() {
            return People()
            .filter(function(p) {
              return p.properties.FlowingContractsCount > 0 && p.properties.ActiveUsersCount > 0
            })
          }).done(function(results) {
            // companies with at least one active contract and user
            var NA_Wholesale_CU = new Set();
            var NA_Auction_CU = new Set();
            var NA_DS_CU = new Set();
            var NA_Both_CU = new Set();
           
            var A_Auction_CU = new Set();
            var A_DS_CU = new Set();
            var A_Both_CU = new Set();
            
            var Retail_Auction_CU = new Set();
            
            var companiesCU = [];
            
            for (var i = 0; i < results.length; i++) {
                // if (results[i].properties.CompanyName.toUpperCase() == ("Leidos, Inc.").toUpperCase()) {
                //   console.log(results[i]);
                // } else {
                //   console.log("not found");
                // }
                
                var result = results[i].properties;
                if (!(result.hasOwnProperty('CustomerType')) || result.CustomerType === null) { // Without Advisory (NA)
                  if (result.BusinessTypes != null) {
                      if (result.BusinessTypes == "Wholesale") { // NA-Wholesale
                      NA_Wholesale_CU.add(result.CompanyName);
                    } else {
                      var auction = false;
                      var ds = false;
                      if (result.EventTypes != null) {
                        auction = result.EventTypes.includes("Auction");
                        ds = result.EventTypes.includes("Direct Sourcing");
                      }
                      if (auction && ds) { // both
                        NA_Both_CU.add(result.CompanyName);
                      } else if (auction) { // auction-only
                        NA_Auction_CU.add(result.CompanyName);
                      } else if (ds) { // direct sourcing only
                        NA_DS_CU.add(result.CompanyName);
                      }
                    }
                  } else { // With Advisory (A)
                      var auction = false;
                      var ds = false;
                      if (result.EventTypes != null) {
                        auction = result.EventTypes.includes("Auction");
                        ds = result.EventTypes.includes("Direct Sourcing");
                      }
                      if (auction && ds) { // both
                        A_Both_CU.add(result.CompanyName);
                      } else if (auction) { // auction-only
                        A_Auction_CU.add(result.CompanyName);
                      } else if (ds) { // direct sourcing only
                        A_DS_CU.add(result.CompanyName);
                      }
                   }
                }
              }
              
              Retail_Auction_CU = new Set(...[NA_Auction_CU,...NA_Both_CU,...A_Auction_CU,...A_Both_CU]);
                          
              companiesCU.push(NA_Auction_CU);
              companiesCU.push(NA_DS_CU);
              companiesCU.push(NA_Both_CU);
              companiesCU.push(NA_Wholesale_CU);
              companiesCU.push(A_Auction_CU);
              companiesCU.push(A_DS_CU);
              companiesCU.push(A_Both_CU);
              companiesCU.push(Retail_Auction_CU);
              
              // console.log("Companies With At Least 1 Active Contract and Active User Account");
              // console.log(NA_Auction_CU);
              // console.log(NA_DS_CU);
              // console.log(NA_Wholesale_CU);
              // console.log(NA_Both_CU);
              // console.log(A_Auction_CU);
              // console.log(A_DS_CU);
              // console.log(A_Both_CU);
              // console.log(Retail_Auction_CU);
              
              // gets the login chart table
              // var loginChart = document.getElementById("loginChart");
              // var rows = loginChart.children[0].children;
              
              // working here
              var CUColumn = 2;
              var rows = document.querySelectorAll("#loginChart tr");
              // fills out the at least 1 active contract and active user column
              rows.forEach(function(row,i) {
                if (row.firstElementChild.tagName.toLowerCase() == "td") {
                  row.children[CUColumn].textContent = companiesCU[i-1].size;
                }
              });
              runQuery();
          });
        }
        var runQuery = function() {
            var error = document.getElementById("error");
            var errorMessage = "";
            
            var from = document.getElementById("from");
            var to = document.getElementById("to");
            
            if (from.value === "" || to.value === "") {
              errorMessage += "Please Choose a Valid Date for From and To.\n";
            } else {
              f = Date.parse(from.value);
              t = Date.parse(to.value);
              if (f > t) {
                errorMessage += "The From Date Should Not Be After The To Date.\n"
              }
            }
            
            if (errorMessage != "") {
              error.innerHTML = errorMessage;
              error.style.color = "red";
              
              if (from.value === "") {
                from.style.background = "red";
              }
              
              if (to.value === "") {
                to.style.background = "red";
              }
            } else {
              // shows the loader 
              document.getElementById("loader").style.display = "block";
              
              // no error, so set the backgrounds of the dates to white
              from.style.background = "white";
              to.style.background = "white";
              
              // remove errorMessage
              error.innerHTML = "";
              
              var params = {
                fromDate: from.value,
                toDate: to.value
              };
              setTimeout(
              MP.api.jql(function main() {
               return Events ({
                    from_date: params.fromDate,
                    to_date: params.toDate,
                  event_selectors:[{event: "Login"}]
                  })
                  
                  .groupBy(
                    mixpanel.multiple_keys(["properties.EventType","properties.BusinessType", "properties.CustomerType", "properties.CompanyName"]),
                    //Take a count of the Companies in Event Type and Business Type categories 
                    mixpanel.reducer.any()
                  )
                  
                  // we don't want to count EnerNOC logins
                  .filter(
                    function(e) {return e.value.properties.CompanyName != "EnerNOC" 
                    && e.value.properties.BusinessType != null && e.value.properties.EventType != null
                    }
                    )
                  
              }, params).done(function(results) {
                // total number of companies
                var NA_Wholesale_Total = new Set();
                var NA_Auction_Total = new Set();
                var NA_DS_Total = new Set();
                var NA_Both_Total = new Set();
               
                var A_Auction_Total = new Set();
                var A_DS_Total = new Set();
                var A_Both_Total = new Set();
                
                var Retail_Auction_Total = new Set();
                
                var totalCompanies = [];
                
                // portal companies
                var NA_Wholesale_Portal = new Set();
                var NA_Auction_Portal = new Set();
                var NA_DS_Portal = new Set();
                var NA_Both_Portal = new Set();
               
                var A_Auction_Portal = new Set();
                var A_DS_Portal = new Set();
                var A_Both_Portal = new Set();
                
                var Retail_Auction_Portal = new Set();
                
                var portalCompanies = [];
                
                
                for (var i = 0; i < results.length; i++) {
                  // if (results[i].value.properties.CompanyName.toUpperCase() == ("Alkermes, Inc.").toUpperCase()) {
                  //   console.log(results[i]);
                  // } else {
                  //   console.log("not found");
                  // }
                  
                  var result = results[i].value.properties;
                  var activeContract = result.FlowingContractCount;
                  var activeUser = result.ActiveUsersAtCustomerCount;
                  var isPortalViewer = false;
                  if (result.RoleAttribute) {
                    isPortalViewer = result.RoleAttribute.includes("PortalViewer");
                  }
                  if (!(result.hasOwnProperty('CustomerType')) || result.CustomerType === null) { // Without Advisory (NA)
                    if (result.BusinessType != null) {
                      if (result.BusinessType == "Wholesale") { // NA-Wholesale
                          NA_Wholesale_Total.add(result.CompanyName);
                          if (isPortalViewer) {
                            NA_Wholesale_Portal.add(result.CompanyName);
                          }
                        } else {
                          var auction = false;
                          var ds = false;
                          if (result.EventType != null) {
                            auction = result.EventType.includes("Auction");
                            ds = result.EventType.includes("Direct Sourcing");
                          }
                          if (auction && ds) { // both
                              NA_Both_Total.add(result.CompanyName);
                              if (isPortalViewer) {
                                 NA_Both_Portal.add(result.CompanyName);
                              }
                          } else if (auction) { // auction-only
                              NA_Auction_Total.add(result.CompanyName);
                              if (isPortalViewer) {
                                 NA_Auction_Portal.add(result.CompanyName);
                              }
                          } else if (ds) { // direct sourcing only
                              NA_DS_Total.add(result.CompanyName);
                              if (isPortalViewer) {
                                 NA_DS_Portal.add(result.CompanyName);
                              }
                          }
                        }
                      } else { // With Advisory (A)
                          var auction = false;
                          var ds = false;
                          if (result.EventType != null) {
                            auction = result.EventType.includes("Auction");
                            ds = result.EventType.includes("Direct Sourcing");
                          }
                          if (auction && ds) { // both
                              A_Both_Total.add(result.CompanyName);
                              if (isPortalViewer) {
                                A_Both_Portal.add(result.CompanyName);
                            }
                          } else if (auction) { // auction-only
                              A_Auction_Total.add(result.CompanyName);
                              if (isPortalViewer) {
                                A_Auction_Portal.add(result.CompanyName);
                              }
                          } else if (ds) { // direct sourcing only
                             A_DS_Total.add(result.CompanyName);
                             if (isPortalViewer) {
                                A_DS_Portal.add(result.CompanyName);
                            }
                          }
                      }
                  }
                }
                Retail_Auction_Total = new Set([...NA_Auction_Total,...NA_Both_Total,...A_Auction_Total,...A_Both_Total]);
                Retail_Auction_Portal = new Set([...NA_Auction_Portal,...NA_Both_Portal,...A_Auction_Portal,...A_Both_Portal]);
                
                totalCompanies.push(NA_Auction_Total);
                totalCompanies.push(NA_DS_Total);
                totalCompanies.push(NA_Both_Total);
                totalCompanies.push(NA_Wholesale_Total);
                totalCompanies.push(A_Auction_Total);
                totalCompanies.push(A_DS_Total);
                totalCompanies.push(A_Both_Total);
                totalCompanies.push(Retail_Auction_Total);
                
                portalCompanies.push(NA_Auction_Portal);
                portalCompanies.push(NA_DS_Portal);
                portalCompanies.push(NA_Both_Portal);
                portalCompanies.push(NA_Wholesale_Portal);
                portalCompanies.push(A_Auction_Portal);
                portalCompanies.push(A_DS_Portal);
                portalCompanies.push(A_Both_Portal);
                portalCompanies.push(Retail_Auction_Portal);
                
                
                // console.log("Total Number Of Companies");
                // console.log(NA_Auction_Total);
                // console.log(NA_DS_Total);
                // console.log(NA_Both_Total);
                // console.log(NA_Wholesale_Total);
                // console.log(A_Auction_Total);
                // console.log(A_DS_Total);
                // console.log(A_Both_Total);
                // console.log(Retail_Auction_Total);
                
                var table = document.getElementById("loginChart");
                var rows = table.children[0].children;
                var rows = document.querySelectorAll("#loginChart tr");
                
                // fills in the columns of the table
                // rows[i+1] chooses the row
                // .children[4] chooses the column
                // totalCompanies is an array of sets
                var customerColumn = 2;
                var totalColumn = 3;
                var portalViewerColumn = 4;
                var percentageColumn = 5;
                rows.forEach(function(row,i) {
                  if (row.firstElementChild.tagName.toLowerCase() == "td") {
                    // number of companies with at least one contract and at least one active user column (2)
                    var CUSize = parseInt(row.children[customerColumn].textContent);
                    
                    var td = row.children[totalColumn];
                    td.classList.add("blueU");
                    // adds onclick
                    td.onclick = function(e) {
                      console.log(e);
                      if (e.srcElement.classList[0] == "blueU") {
                        // gets the row number if the table
                        var rowNum = parseInt(e.path[1].children[e.path[1].childElementCount-1].innerText);
                        
                        // shows the header span
                        var loginChartCompanyNamesSpan = document.getElementById("loginChartCompanyNamesSpan");
                        var ct = e.target.parentElement.children[0].innerText;
                        var cc = e.target.parentElement.children[1].innerText;
                        loginChartCompanyNamesSpan.textContent = ct + " " + cc + ":";
                        
                        
                        // gets the row of the table, and the correct set (by index)
                        var data = Array.from(totalCompanies[rowNum]).sort();
                        var numOfCompanies = data.length;
                        var formattedData = [];
                        for (let i = 0; i < data.length; i++) {
                          formattedData.push([data[i]]);
                        }
                        // gets table and makes the table
                        var tbody = document.querySelector("#loginChartCompanyNames tbody");
                        // makes and displays the table
                        // if (numOfCompanies >= 1 && numOfCompanies <= 7) {
                        //   makeNColumnTable(1,1,formattedData,tbody);
                        // } else 
                        if (numOfCompanies >= 1 && numOfCompanies <= 15){
                          makeNColumnTable(1,2,formattedData,tbody);
                        } else if (numOfCompanies >= 16 && numOfCompanies <= 22){
                          makeNColumnTable(1,3,formattedData,tbody);
                        } else {
                          makeNColumnTable(1,4,formattedData,tbody);
                        }
                        loginChartCompanyNames.style.display = "block";
                        // if (numOfCompanies) {
                        //   loginChartCompanyNames.style.display = "block";
                        // } else {
                        //   loginChartCompanyNames.style.display = "none";
                        // }
                     }
                      
                    }
                    // gets companies with a login (3)
                    var total = totalCompanies[i-1].size;
                    if (total == 0) {
                      td.classList.remove("blueU");
                    }
                    
                    // fills out companies with a login column (3)
                    row.children[totalColumn].textContent = total;
                    
                    // fills out the portal companies column (4)
                    var portal = portalCompanies[i-1].size; 
                    // fills out the total companies column (4)
                    row.children[portalViewerColumn].textContent = portal;
                    
                    // Total/CU * 100% Percentage column (5)
                    var perc = (total/CUSize * 100).toFixed(2);
                    if (isNaN(perc) || !isFinite(perc)) {
                      row.children[percentageColumn].textContent = "0.00%";
                    } else {
                      row.children[percentageColumn].textContent = perc + "%";
                    }
                  }
                });
                
                // hides the loader
                document.getElementById("loader").style.display = "none";
              })
              ,0); // timeout
            }
        }
        
        // USER ROLE TABLE
        var setUserRoleTableName = function() {
          var quarter = document.getElementById("userRoleTableQuarter").value;
          var quarterNames = ["Q1", "Q2", "Q3", "Q4"];
          var year = document.getElementById("userRoleTableYear").value;
          var title = "";
          title += quarterNames[quarter];
          title += " ";
          title += year;
          
          var firstRowTH = document.querySelector("#userRoleTable tr th:first-child");
          firstRowTH.textContent = title;
        }
        var uniqueUserLoginsQuery = function() {
          var fromLogins = document.getElementById("fromLogins");
          var toLogins = document.getElementById("toLogins");
          
          var params = {
            from: fromLogins.value,
            to: toLogins.value
          };

         MP.api.jql(function main() {
            return Events({
              from_date: params.from,
              to_date: params.to,
              event_selectors:[{event: "Login"}]
            })
              .groupBy(["distinct_id"], mixpanel.reducer.any())
              .groupBy(["value.properties.UserRole"], mixpanel.reducer.count()) 
          },params).done(function(results){
              var enernoc = 0;
              var supplier = 0;
              var partner = 0;
              var customer = 0;
              
              results.forEach(function(result) {
                var count = result.value;
                if (result.key[0] == "Employee") {
                  enernoc = count;
                } else if (result.key[0] == "Bidder") {
                  supplier = count;
                } else if (result.key[0] == "Partner") {
                  partner = count;
                } else if (result.key[0] == "Customer") {
                  customer = count;
                }
              });
              
              var uniqueLogins = [enernoc, supplier, partner, customer];
              
              var firstRow = document.querySelectorAll("#userRoleTable tr:nth-child(2) td");
              firstRow.forEach(function(td,index) {
                if (index > 0) { // first td is a label
                  td.textContent = uniqueLogins[index-1];
                }
              });
              totalUserLoginsQuery();
          })
            
        }
        var totalUserLoginsQuery = function() {
          var fromLogins = document.getElementById("fromLogins");
          var toLogins = document.getElementById("toLogins");
          
          var params = {
            from: fromLogins.value,
            to: toLogins.value
          };
          
          setTimeout(
           MP.api.jql(function main() {
              return Events({
                from_date: params.from,
                to_date: params.to,
                event_selectors:[{event: "Login"}]
              })
                .groupBy(["properties.UserRole"], mixpanel.reducer.count())
            },params).done(function(results){
                var enernoc = 0;
                var supplier = 0;
                var partner = 0;
                var customer = 0;
                
                results.forEach(function(result) {
                  var count = result.value;
                  if (result.key[0] == "Employee") {
                    enernoc = count;
                  } else if (result.key[0] == "Bidder") {
                    supplier = count;
                  } else if (result.key[0] == "Partner") {
                    partner = count;
                  } else if (result.key[0] == "Customer") {
                    customer = count;
                  }
                });
                
                var totalLogins = [enernoc, supplier, partner, customer];
                
                var firstRow = document.querySelectorAll("#userRoleTable tr:nth-child(3) td");
              firstRow.forEach(function(td,index) {
                if (index > 0) { // first td is a label
                  td.textContent = totalLogins[index-1];
                }
              });
                calculateLoginPerUser();
            })
          ,0); //set timeout
        }
        var calculateLoginPerUser = function() {
          var userRoleTable = document.getElementById("userRoleTable");
          var uniqueLoginsRow = userRoleTable.children[0].children[1];
          var totalLoginsRow = userRoleTable.children[0].children[2];
          var loginPerUserRow = userRoleTable.children[0].children[3];
          for (let i = 1; i < loginPerUserRow.children.length; i++) {
            var uniqueLoginsValue = parseInt(uniqueLoginsRow.children[i].textContent);
            var totalLoginsValue = parseInt(totalLoginsRow.children[i].textContent);
            var loginPerUserValue = (totalLoginsValue/uniqueLoginsValue).toFixed(1);
            if (isNaN(loginPerUserValue) || !isFinite(loginPerUserValue)) {
              loginPerUserRow.children[i].textContent = "0.0";
            } else {
              loginPerUserRow.children[i].textContent = loginPerUserValue;
            }
          }
          document.getElementById("loader2").style.display = "none";
        }
        // updates from and to dates based on which quarter is chosen
        var updateUserRoleTableQuarter = function() {
          var quarter = document.getElementById("userRoleTableQuarter").value;
          var year = document.getElementById("userRoleTableYear").value;
          var quarterDates = [["-01-01","-03-31"],["-04-01","-06-30"],["-07-01","-09-30"],["-10-01","-12-31"]];
          
          fromLogins.value = year + quarterDates[quarter][0];
          toLogins.value = year + quarterDates[quarter][1];
        }
        
        // runs all the functions to make the user role table
        var userRoleTableQuery = function() {
          document.getElementById("loader2").style.display = "block";
          setUserRoleTableName();
          uniqueUserLoginsQuery();
        }
        
        // USER ROLE GRAPH
        // makes a quarterly login chart
        var makeQuarterLoginChart = function(from,to,year,quarter,max,stepSize) {
          var params = {
            from: year + from,
            to: year + to
          };
          
          var loginType = document.getElementById("userRoleGraphSelect").value;
          
          if (loginType == "unique") { // unique logins
            MP.api.jql(function main() {
            return Events({
              from_date: params.from,
              to_date: params.to,
              event_selectors:[{event: "Login"}]
            })
              .groupBy(["distinct_id"], mixpanel.reducer.any())
              .groupBy(["value.properties.UserRole"], mixpanel.reducer.count()) 
          },params).done(function(results){
              var enernoc = 0;
              var supplier = 0;
              var partner = 0;
              var customer = 0;
              
              for (let i = 0; i < results.length; i++) {
                var result = results[i].value;
                if (results[i].key[0] == "Employee") {
                  enernoc = result;
                } else if (results[i].key[0] == "Bidder") {
                  supplier = result;
                } else if (results[i].key[0] == "Partner") {
                  partner = result;
                } else if (results[i].key[0] == "Customer") {
                  customer = result;
                }
              }

              var quarterIndex = quarter - 1;
                var table = document.getElementById("userRoleGraph");
                var tbody = table.children[1];
                if (quarterIndex == 0 || quarterIndex == 1) { // chooses the correct tr
                  var tr = tbody.children[0];
                } else if (quarterIndex == 2 || quarterIndex == 3) {
                  var tr = tbody.children[1];
                }
                
                var td = tr.children[quarterIndex % 2];
                td.innerHTML = "<canvas></canvas>";
                
                // chooses the correct canvas in the table
                let canvas = td.children[0];
                
                let barChart = new Chart(canvas, {
                		type: "bar",
                    data: {
                    	labels: ["EnerNOC User ("+enernoc+")", "Supplier ("+supplier+")", "Partner ("+partner+")", "Customer ("+customer+")"],
                      datasets: [{
                      		label: "Quarter " + quarter + " Unique Logins",
                          data: [
                          		enernoc,
                              supplier,
                              partner,
                              customer
                          ],
                          backgroundColor: "#0080ff"
                      }]
                    },
                    options: {
                      scales: {
                        yAxes: [{
                          ticks: {
                            min: 0,
                            max: max,
                            stepSize: stepSize
                          }
                        }]
                      },
                      onHover: function(e) {
                        var activeBars = barChart.getElementAtEvent(e)[0];
                        if (activeBars) {
                          document.body.style.cursor = "pointer";  
                        } else {
                          document.body.style.cursor = "default";
                        }
                        
                      }
                    }
                });
                
              
              canvas.onclick = function(e) {
                var activeBars = barChart.getElementAtEvent(e)[0];
                if (activeBars) {
                  // show loader
                  var loader = document.getElementById("loader4");
                  loader.style.display = "block";
                  
                	var year = document.getElementById("userRoleGraphYear").value;
                	var quarter = parseInt(activeBars._model.datasetLabel.split(" ")[1]);
                	var userRole = activeBars._model.label.split(" ")[0];
                	if (userRole == "EnerNOC") {
                	  var paramsUserRole = "Employee";
                	} else if (userRole == "Supplier") {
                	  var paramsUserRole = "Bidder";
                	} else if (userRole == "Partner") {
                	  var paramsUserRole = "Partner";
                	} else if (userRole == "Customer") {
                	  var paramsUserRole = "Customer";
                	}
                	var quarterIndex = quarter - 1;
                	var quarters = [["-01-01","-03-31"],["-04-01","-06-30"],["-07-01","-09-30"],["-10-01","-12-31"]];
                	var params = {
                	  from: year + quarters[quarterIndex][0],
                	  to: year + quarters[quarterIndex][1],
                	  userRole: paramsUserRole
                	};
                	
                	// change title
                  var span  = document.getElementById("userRoleGraphCompanyNames");
                  span.textContent = year + " Q" + quarter + " " + userRole + " Unique User Logins:";
                  // show title
                  span.style.display = "block";
                	
                	MP.api.jql(function main() {
                    return Events({
                      from_date: params.from,
                      to_date:   params.to,
                      event_selectors:[{event: "Login"}]
                    })
                    .filter(function(e){
                      return e.properties.UserRole == params.userRole
                    })
                    .groupBy(["properties.CompanyName","distinct_id"], mixpanel.reducer.any())
                    //.groupBy(["value.properties.CompanyName"], mixpanel.reducer.count())
                  },params).done(function(results) {
                    
                    
                    var data = [];
                    for (let i = 0; i < results.length; i++) {
                      var companyName = results[i].key[0];
                      var userID = results[i].key[1];
                      var tuple = [companyName,userID];
                      data.push(tuple);
                    }
                    
                    var userRoleCompaniesUniqueTable = document.getElementById("userRoleCompaniesUniqueTable");
                    var userRoleCompaniesTotalTable = document.getElementById("userRoleCompaniesTotalTable");
                    var tbody = userRoleCompaniesUniqueTable.children[0];
                    makeNColumnTable(2,3,data,tbody);
                    userRoleCompaniesUniqueTable.style.display = "block";
                    userRoleCompaniesTotalTable.style.display = "none";
                    
                    // hide loader
                    loader.style.display = "none";
                    //makeUserRoleCompaniesTable(results);
                	});
                }
              }
          });
          } else if (loginType == "total") { // total logins
            MP.api.jql(function main() {
              return Events({
                from_date: params.from,
                to_date: params.to,
                event_selectors:[{event: "Login"}]
              })
                .groupBy(["properties.UserRole"], mixpanel.reducer.count())
            },params).done(function(results){
                var enernoc = 0;
                var supplier = 0;
                var partner = 0;
                var customer = 0;
                
                // gets the values for each of the 4 user roles
                for (let i = 0; i < results.length; i++) {
                  var total = results[i].value;
                  if (results[i].key[0] == "Employee") {
                    enernoc = total;
                  } else if (results[i].key[0] == "Bidder") {
                    supplier = total;
                  } else if (results[i].key[0] == "Partner") {
                    partner = total;
                  } else if (results[i].key[0] == "Customer") {
                    customer = total;
                  }
                }
                
                var quarterIndex = quarter - 1;
                var table = document.getElementById("userRoleGraph");
                var tbody = table.children[1];
                if (quarterIndex == 0 || quarterIndex == 1) { // chooses the correct tr
                  var tr = tbody.children[0];
                } else if (quarterIndex == 2 || quarterIndex == 3) {
                  var tr = tbody.children[1];
                }
                
                var td = tr.children[quarterIndex % 2];
                td.innerHTML = "<canvas></canvas>";
                
                // chooses the correct canvas in the table
                let canvas = td.children[0];
                
                let barChart = new Chart(canvas, {
                		type: "bar",
                    data: {
                    	labels: ["EnerNOC User ("+enernoc+")", "Supplier ("+supplier+")", "Partner ("+partner+")", "Customer ("+customer+")"],
                      datasets: [{
                      		label: "Quarter " + quarter + " Total Logins",
                          data: [
                          		enernoc,
                              supplier,
                              partner,
                              customer
                          ],
                          backgroundColor: "#0080ff"
                      }]
                    },
                    options: {
                      scales: {
                        yAxes: [{
                          ticks: {
                            min: 0,
                            max: max,
                            stepSize: stepSize
                          }
                        }]
                      },
                      onHover: function(e) {
                        var activeBars = barChart.getElementAtEvent(e)[0];
                        if (activeBars) {
                          document.body.style.cursor = "pointer";  
                        } else {
                          document.body.style.cursor = "default";
                        }
                      }
                    }
                    
                });
                
                canvas.onclick = function(e) {
                  var activeBars = barChart.getElementAtEvent(e)[0];
                  if (activeBars) {
                    // show loader
                    var loader = document.getElementById("loader4");
                    loader.style.display = "block";
                  
                  	var year = document.getElementById("userRoleGraphYear").value;
                  	var quarter = parseInt(activeBars._model.datasetLabel.split(" ")[1]);
                  	var userRole = activeBars._model.label.split(" ")[0];
                  	if (userRole == "EnerNOC") {
                  	  var paramsUserRole = "Employee";
                  	} else if (userRole == "Supplier") {
                  	  var paramsUserRole = "Bidder";
                  	} else if (userRole == "Partner") {
                  	  var paramsUserRole = "Partner";
                  	} else if (userRole == "Customer") {
                  	  var paramsUserRole = "Customer";
                  	}
                  	var quarterIndex = quarter - 1;
                  	var quarters = [["-01-01","-03-31"],["-04-01","-06-30"],["-07-01","-09-30"],["-10-01","-12-31"]];
                  	var params = {
                  	  from: year + quarters[quarterIndex][0],
                  	  to: year + quarters[quarterIndex][1],
                  	  userRole: paramsUserRole
                  	};
                  	
                    	// change title
                    var span  = document.getElementById("userRoleGraphCompanyNames");
                    span.textContent = year + " Q" + quarter + " " + userRole + " Total User Logins:";
                  	// show title
                  	span.style.display = "block";
                  	
                  	MP.api.jql(function main() {
                      return Events({
                        from_date: params.from,
                        to_date:   params.to,
                        event_selectors:[{event: "Login"}]
                      })
                      .filter(function(e){
                        return e.properties.UserRole == params.userRole
                      })
                      .groupBy(["properties.CompanyName","distinct_id"],mixpanel.reducer.count())
                    },params).done(function(results) {
                      var data = [];
                      for (let i = 0; i < results.length; i++) {
                        var companyName = results[i].key[0];
                        var userID = results[i].key[1];
                        var logins = results[i].value;
                        var triple = [companyName,userID,logins];
                        data.push(triple);
                      }
                      
                      var userRoleCompaniesUniqueTable = document.getElementById("userRoleCompaniesUniqueTable");
                      var userRoleCompaniesTotalTable = document.getElementById("userRoleCompaniesTotalTable");
                      var tbody = userRoleCompaniesTotalTable.children[0];
                      makeNColumnTable(3,3,data,tbody);
                      userRoleCompaniesUniqueTable.style.display = "none";
                      userRoleCompaniesTotalTable.style.display = "block";
                      
                      // hide loader
                      loader.style.display = "none";
                  	});
                  }
                }
                


            });
          }
        }
        // makes an N column table
        // data should be have n columns
        var makeNColumnTable = function(columns,repeated,data,tbody) {
            // working here
            // rewrites the header of the table
            var headerRow = tbody.children[0];
            var headers = [];
            for (let i = 0; i < columns; i++) {
              headers.push(headerRow.children[i].textContent);
            }
            tbody.innerHTML = "<tr></tr>";
            var tr = tbody.children[0];
            for (let i = 0; i < repeated; i++) {
              for (let j = 0; j < headers.length; j++) {
                var th = document.createElement("th");
                var txt = document.createTextNode(headers[j]);
                th.appendChild(txt);
                tr.appendChild(th);
              }
            }
            // make the table (tds)
        		var dataLength = data.length;
            // totalColumns is the actual number of columns
            if (dataLength % repeated) { // trNum is the number of rows needed to be added to the table
            	var trNum = Math.floor(dataLength/repeated) + 1;
            } else {
            	var trNum = dataLength/repeated;	
            }
            for (let i = 0; i < trNum; i++) { // adds in the trs
            	var tr = document.createElement("tr");
              // adds in the tds
              for (let j = 0; j < repeated; j++) { // number of "big/repeated" columns
                var dataIndex = i+j*trNum;
                var dataArray = data[dataIndex];
                	for (let k = 0; k < columns; k++) { // number of regular column
                  	// going horizontally, you add the number of rows
                    var td = document.createElement("td");
                     if ( dataIndex < dataLength) { // only indices less than the length of the data is put in
                      var cellData = document.createTextNode(dataArray[k]);
                    } else {
                      var cellData = document.createTextNode("");
                    } 
                    td.appendChild(cellData);
                    tr.appendChild(td);
                  }
              }
              // appends the row to the table
              tbody.appendChild(tr);
            }	
        }
        
        var maxValueInQuarter = function(from,to,year) {
          var params = {
          from: year + from,
          to: year + to
          };
          
          if (from == "-01-01") {
            var quarter = 0;
          } else if (from == "-04-01") {
            var quarter = 1;
          } else if (from == "-07-01") {
            var quarter = 2;
          } else if (from == "-10-01") {
            var quarter = 3;
          }
          
          var maxIDs = ["userRoleMaxQ1","userRoleMaxQ2","userRoleMaxQ3","userRoleMaxQ4"]
          
          var loginType = document.getElementById("userRoleGraphSelect").value;
          if (loginType == "unique") {
            MP.api.jql(function main() {
            return Events({
              from_date: params.from,
              to_date: params.to,
              event_selectors:[{event: "Login"}]
            })
              .groupBy(["distinct_id"], mixpanel.reducer.any())
              .groupBy(["value.properties.UserRole"], mixpanel.reducer.count()) 
          },params).done(function(results){
              var enernoc = 0;
              var supplier = 0;
              var partner = 0;
              var customer = 0;
              
              results.forEach(function(result) {
                  var count = result.value;
                  if (result.key[0] == "Employee") {
                    enernoc = count;
                  } else if (result.key[0] == "Bidder") {
                    supplier = count;
                  } else if (result.key[0] == "Partner") {
                    partner = count;
                  } else if (result.key[0] == "Customer") {
                    customer = count;
                  }
                });
              
              // gets the highest user role value
              var userRoles = [enernoc,supplier,partner,customer];
              
              var max = userRoles[0];
              for (let i = 1; i < userRoles.length; i++) {
                if (userRoles[i] > max) {
                  max = userRoles[i];
                }
              }
              document.getElementById(maxIDs[quarter]).value = max;
              
          });
          } else if (loginType == "total") {
            MP.api.jql(function main() {
              return Events({
                from_date: params.from,
                to_date: params.to,
                event_selectors:[{event: "Login"}]
              })
                .groupBy(["properties.UserRole"], mixpanel.reducer.count())
            },params).done(function(results){
                var enernoc = 0;
                var supplier = 0;
                var partner = 0;
                var customer = 0;
                
                // gets the values for each of the 4 user roles
                for (let i = 0; i < results.length; i++) {
                  var total = results[i].value;
                  if (results[i].key[0] == "Employee") {
                    enernoc = total;
                  } else if (results[i].key[0] == "Bidder") {
                    supplier = total;
                  } else if (results[i].key[0] == "Partner") {
                    partner = total;
                  } else if (results[i].key[0] == "Customer") {
                    customer = total;
                  }
                }
                
                // gets the highest user role value
                var userRoles = [enernoc,supplier,partner,customer];
                
                var max = userRoles[0];
                for (let i = 1; i < userRoles.length; i++) {
                  if (userRoles[i] > max) {
                    max = userRoles[i];
                  }
                }
                document.getElementById(maxIDs[quarter]).value = max;
                
            });
          }
        }
        // creates all the quarterly login charts
        var makeAllLoginCharts = function(max,stepSize) {
          var year = document.getElementById("userRoleGraphYear").value;
          // calculates max of all values in all quarters
          // var q1Max = maxValueInQuarter("-01-01","-03-31",year);
          // console.log(q1Max);
          // maxValueInQuarter("-04-01","-06-30",year);
          // console.log(q2Max);
          // var q3Max = maxValueInQuarter("-07-01","-9-30",year);
          // var q4Max = maxValueInQuarter("-10-01","-12-31",year);
          // var maxes = [q1Max,q2Max,q3Max,q4Max]
          // var max = q1Max;
          // for (let i = 1; i < maxes.length; i++) {
          //   if (maxes[i] > q1Max) {
          //     max = maxes[i];
          //   }
          // }
          
          // // calculates step size
          // var stepSize = Math.ceil(max / 9);
          
          
          makeQuarterLoginChart("-01-01","-03-31",year,1,max,stepSize);
          makeQuarterLoginChart("-04-01","-06-30",year,2,max,stepSize);
          makeQuarterLoginChart("-07-01","-9-30",year,3,max,stepSize);
          makeQuarterLoginChart("-10-01","-12-31",year,4,max,stepSize);
          // document.getElementById("loader3").style.display = "none";
        }
        
        // set user role graph table
        var setUserRoleGraph = function() {
            document.getElementById("loader3").style.display = "block";
            
            // hides the tables and the span
            document.getElementById("userRoleCompaniesUniqueTable").style.display = "none";
            document.getElementById("userRoleCompaniesTotalTable").style.display = "none";
            document.getElementById("userRoleGraphCompanyNames").style.display = "none";
            
            // resets max values
            var maxes = ["userRoleMaxQ1","userRoleMaxQ2","userRoleMaxQ3","userRoleMaxQ4"];
            maxes.forEach(function(quarter) {
              document.getElementById(quarter).value = "";
            });
            
            // calculates max of all values in all quarters
            var year = document.getElementById("userRoleGraphYear").value;
            maxValueInQuarter("-01-01","-03-31",year);
            maxValueInQuarter("-04-01","-06-30",year);
            maxValueInQuarter("-07-01","-9-30",year);
            maxValueInQuarter("-10-01","-12-31",year);
            
            function makeAllLoginChartsTemp() {
              var q1 = parseInt(document.getElementById("userRoleMaxQ1").value);
              var q2 = parseInt(document.getElementById("userRoleMaxQ2").value);
              var q3 = parseInt(document.getElementById("userRoleMaxQ3").value);
              var q4 = parseInt(document.getElementById("userRoleMaxQ4").value);
              
              if (!isNaN(q1) && !isNaN(q2) && !isNaN(q3) && !isNaN(q4)) {
                var maxes = [q1,q2,q3,q4];
                var max = maxes[0];
                for (let i = 1; i < maxes.length; i++) {
                  var current = maxes[i];
                  if (current > max) {
                    max = current;
                  }
                }

                max = Math.ceil(max/100)*100;
                stepSize = max / 10;
                if (stepSize > 100) {
                  stepSize = Math.ceil(stepSize/100)*100;
                } else if (stepSize > 1000) {
                  stepSize = Math.ceil(stepSize/1000)*1000;
                }
                makeAllLoginCharts(max,stepSize);
              } else {
                setTimeout(makeAllLoginChartsTemp,500);
              }
            }
            makeAllLoginChartsTemp();
            
            //makeAllLoginCharts();
            
            // changes the caption of the table
            var year = document.getElementById("userRoleGraphYear").value;
            var caption = document.querySelector("#userRoleGraph caption");
            var loginType = document.getElementById("userRoleGraphSelect").value;
            if (loginType == "unique") {
              caption.textContent = year + " Quarterly Unique Logins";
            } else if (loginType == "total") {
              caption.textContent = year + " Quarterly Total Logins";
            }
            document.getElementById("loader3").style.display = "none";
            
            
          }
          
        // SET DATES AND LABELS
        // set year
        var setCurrentDates = function(year) {
          // sets the year for user role table and graph
          document.getElementById("userRoleTableYear").value = year;
          document.getElementById("userRoleGraphYear").value = year;
        }
        // set labels
        var setLabels = function(year) {
          var caption = document.querySelector("#userRoleGraph caption");
          var loginType = document.getElementById("userRoleGraphSelect").value;
          if (loginType == "unique") {
            caption.textContent = year + " Quarterly Unique Logins";
          } else if (loginType == "total") {
            caption.textContent = year + " Quarterly Total Logins";
          }
        }
        
        
        // ON LOAD
        window.onload = function () {
          // gets the current date and sets dates/labels
          var d = new Date();
          var thisYear = d.getFullYear();
          setCurrentDates(thisYear);
          setLabels(thisYear);

          // sets the from and to date for the user role table (need to set up year before doing this)
          //updateUserRoleTableQuarter(); // uncomment this once we hide from and to dates for user role table
          

          // first table
          runPeopleQuery(); //runQuery()
          
          // second table
          userRoleTableQuery();
          // setUserRoleTableName()
          // uniqueUserLoginsQuery() // totalUserLoginsQuery() // calculateLoginPerUser() 
          
          
          // chart
          //makeAllLoginCharts(); // year depends on the value in the input
          setUserRoleGraph();
          // makeQuarterLoginChart x 4
          
          
          // EVENT LISTENERS
          
          // LOGIN CHART
          // changing the from date above the login chart
          document.getElementById("from").addEventListener("change", function(){
            var from = document.getElementById("from");
            if (from.value != "") {
              from.style.background = "white";
            } else {
              from.style.background = "red";
            }
            runQuery();
            document.getElementById("loginChartCompanyNames").style.display = "none";
            document.getElementById("loginChartCompanyNamesSpan").style.display = "none";
          });
          // changing the to date above the login chart
          document.getElementById("to").addEventListener("change", function(){
            var to = document.getElementById("to");
            if (to.value != "") {
              to.style.background = "white";
            } else {
              to.style.background = "red";
            }
            runQuery();
            document.getElementById("loginChartCompanyNames").style.display = "none";
            document.getElementById("loginChartCompanyNamesSpan").style.display = "none";
          });
          // submit button above the login chart
          document.getElementById("submit").addEventListener("click", runQuery);
          
          // USER ROLE TABLE
          // quarter input for user role table
          document.getElementById("userRoleTableQuarter").addEventListener("change", function() {
              updateUserRoleTableQuarter();
              userRoleTableQuery();
          });
          // year for user role table
          document.getElementById("userRoleTableYear").addEventListener("change", function() {
            // var userRoleTableYear = document.getElementById("userRoleTableYear");
            //   userRoleTableYear.readOnly = true;
              updateUserRoleTableQuarter();
              userRoleTableQuery();
              //userRoleTableYear.readOnly = false;
          });
          // submit button above the user role table
          document.getElementById("userRoleTableSubmit").addEventListener("click", userRoleTableQuery);
          
          // USER ROLE GRAPH
          // user role graph login select
          document.getElementById("userRoleGraphSelect").addEventListener("change", setUserRoleGraph);
          // user role graph year 
          document.getElementById("userRoleGraphYear").addEventListener("change", setUserRoleGraph)
          // submit button for user role graph
          document.getElementById("userRoleGraphSubmit").addEventListener("click", setUserRoleGraph);
        }
    </script>
  </body>
</html>
